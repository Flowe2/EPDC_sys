# 需求分析
> @author: **孔华钦**  
> @time stamp: **2021-01-28 01:06:45**  
> @project name: **EQM sys** - Examination questions management  system  
> @git addr: **`git@github.com:Flowe2/EPDC_sys.git`**

---
## 技术栈

**前端**

1. [Electron][electron_link] - 客户端  
2. [Vue.js][vue.js_link] - 前端框架  
3. [Echarts][echarts_link] - 前端可视化库

<!-- 引用 -->
[electron_link]: https://www.electronjs.org/  
[vue.js_link]: https://cn.vuejs.org/  
[echarts_link]: https://echarts.apache.org/zh/index.html  

**后端**
1. [Node.js][node.js_link] - 服务端

<!-- 引用 -->
[node.js_link]: https://nodejs.org/zh-cn/  

---
## 开发工具

1. [VScode][vscode_link]

<!-- 引用 -->
[vscode_link]: https://code.visualstudio.com/  

---
## 模块功能描述

1. 用户登录功能  
   > 作为用户，有单独的入口，输入帐号和密码，登录到系统中。
2. 用户注册功能  
   > 作为新用户，在用户登陆界面有注册入口，能申请注册新账号。  
3. 管理员登录功能  
   > 作为系统管理员，有单独的管理员入口，能输入管理员帐号和密码，登录到管理员系统中。  
4. 题库功能  
   > 作为用户，登录到系统后，可以按一定条件筛选和查看当前系统题库，并能对题库进行增/删/改操作。  
5. 组卷功能  
   > 作为用户，登录到系统后，在题库中筛选并选择试题，进行组卷，提交后，返回试题/试卷的重复率。  
6. 试卷查重功能  
   > 作为用户，登录到系统后，选择科目、时间，将试卷以文件形式上传，系统处理后，返回试卷重复率。  
7. 用户管理功能  
   > 作为管理员，登录到管理员系统后，可以对用户进行帐号管理，如查看系统日志，管理用户注册、增删用户、协助找回密码等。  

---
## 业务逻辑设计

* 用户
  1. 注册
     * 姓名|帐号(邮箱)|密码
     * 等待管理员验证确认
     * 注册成功
  2. 登录
     * 帐号(邮箱)|密码
     * 登陆成功
  3. 题库
     * 查看题库  
       * 筛选条件: 时间|科目|题型  
       * 返回: 题目列表, 展示 时间|科目|题型 + 题目内容前n字节预览  
       * 点击具体题目, 进入详细展示页面(或弹窗)  
     * 新增题目  
       * 时间|科目|题型, 是否有图片/公式(CheckBox), 上传试题(图片)  
     * 修改题目  
       * 查看题目后, 点击修改按钮, 进入编辑操作  
     * 删除题目  
       * 查看题目后, 点击删除按钮, 删除当前题目  
   4. 组卷查重  
      * 在题库中筛选题目, 对于合适的题目进行勾选操作  
      * 勾选完成后, 预览题目列表  
      * 点击提交 
      * 返回: 各题及整卷的重复率 + *进行可视化展示 + 可点击下载题目列表  
   5. 整卷查重  
      * 在题库界面, 点击"整卷查重按钮", 弹窗上传试卷文件  
      * 等待服务端处理  
      * 返回试题分隔结果 + 各题及整卷重复率 + *进行可视化展示
* 管理员
  1. 管理员登录
     * 帐号(邮箱)|密码
     * 登陆成功
  2. 管理用户
     * 查看所有用户
     * 选择具体用户, 进行删除/修改操作
     * 点击加号手动增加用户
  3. 查看用户日志
     * 筛选条件: 时间|用户|操作类型
     * 返回: 日志列表, 展示 时间|用户|操作类型

---
## 数据库设计
1. userlist - 用户表
   * uemail(_id)
   * uname
   * upwd
   * pass
   * postscript
   * signup
   * lastlog

2. adminlist - 管理员表
   * account(_id)
   * apwd
   * lastlog

3. syslog - 系统日志表
   * _id
   * timestamp
   * role
   * uemail / account
   * operation

4. qubank - 题库 (具体说明见 ##题型模板说明)
   * _id
   * subject
   * type
   * keywords
   * question
   * payload: { src, options, answer }
   * additionTime
   * lastUseTime

5. suggestedSubject - 推荐科目(已有科目, 可通过管理员增减)
   * _id
   * subject
   * keywords

---
## 题型模板说明
1. 通用部分
   ```JSON
    {
        id: "...", //mongodb数据库系统生成唯一_id
        subject: "...", // 科目
        type: "..", // 题型: sc - 单选, mc - 多选, tf - 判断, gf - 填空, sj - 主观
        keywords: ["...", "..."], // 关键词
        question: "...", // 题目内容, 题面, 留空处以"(__)"填充
        payload: {   src: "", // 公式 / 图片资源, 无则为空字符串
                     options: [ // 选项, 有则分别A、B、C、D甚至E、F, 无则[], 长度为0
                     "...", 
                     "...",
                     "...",
                     "..."],
                     answer: ["C"], // 答案, 公式用latex表示
                  },
        additionTime: "2020-04-20", // 入库时间
        lastUseTime: "2020-ss-me" // 上次使用时间
    }
   // lastUseTime - 上次使用时间 说明:
   //  学年: yyyy - school year, 
   //  学期(上/下): fs - first semester, ss - second semester,
   //  考试(堂测/作业/半期/期末): ct - classroom test, hw - homework, me - mid-term exam, fe - final exam
   ```

2. 其他具体题型示例详见[试题模板](./questionTemplates.js)

---
## 接口数据设计

1. 登录-login
   * f to b:
      ```JSON
      {
         "uemail": "abc@123.com",
         "upwd": "123456"
      }
      ```
   * b to f:
      ```JSON
      {
         "ifPass": "ture / false",
         "token": "****",
         "timeStamp" : "Date"
      }
      ```

2. 注册-singup
   * f to b:
      ```JSON
      {
        "uemail": "abc@123.com",
        "uname": "abc",
        "upwd": "123456",
        "postscript": "text area" 
      }
      ```
   * b to f:
    ```JSON
      {
        "ifSuccess": "ture / false",
        "err": "undefined / err message"
      }
    ```

3. 管理员登陆-alogin
   * f to b:
      ```JSON
      {
         "account": "admin",
         "apwd": "666666"
      }
      ```
   * b to f:
      ```JSON
      {
         "ifAPass": "ture / false",
         "atoken": "****",
         "timeStamp" : "time stamp"
      }
      ```

4. 查看题目 - 具体格式见`题型模板`
  * b to f:
      ```JSON
      {
         "token": "token string",
         "type": "sc/mc/tf/gf/sj"
      }
      ```
  * f to b:
      ```JSON
      {
         "questionlist": [ {"...略..."}, {}, ... {} ],
         "counter": n
      }
      ```

5. 上传题目
   * f to b:
      ```JSON
      {
         "token": "token string",
         "newqu": {
            "subject": "",
            "type": "",
            "keywords": [],
            "question": "",
            "payload": {
               "src": "",
               "options": [],
               "answer": [],
            },
            "additionTime": "",
            "lastUseTime": "",
            }
      }
      ```
   * b to f:
      ```JSON
      {
         "ifSuccess": "true / false",
         "err": "undefined / err message"
      }
      ```

6. 修改题目


7. 删除题目


8. 用户维护
   * pull
      * f to b:
         ```JSON
         {
            "atoken": "atoken string"
         }
         ```
      * b to f:
         ```JSON
         {
            "userlist": [ {   "uemail": "user email",
                              "uname": "user name",
                              "lastlog": "time stamp"},
                        {}, ... {} ],
            "counter": n
         }
         ```
   * modify
      * f to b:
         ```JSON
         {
          "atoken": "atoken string",
          "uemail": "uemail",
          "newupwd": "newupwd",
        }
         ```
      * b to f:
         ```JSON
         {
            "ifSuccess": "true / false",
            "err": "undefined / err message"
         }
         ```
   * delete
      * f to b:
         ```JSON
         {
          "atoken": "atoken string",
          "uemail": "uemail",
        }
         ```
      * b to f:
         ```JSON
         {
            "ifSuccess": "true / false",
            "err": "undefined / err message"
         }
         ```

9.  注册管理
   * pull
      * f to b:
         ```JSON
         {
            "atoken": "atoken string"
         }
         ```
      * b to f:
         ```JSON
         {
            "syslog": [ {  "timestamp": "time stamp",
                           "role": "user / admin",
                           "who": "uemail / account",
                           "operation": ""},
                        {}, ... {} ],
            "counter": n
         }
         ```
   * pass
      * f to b:
         ```JSON
         {
          "atoken": "atoken string",
          "uemail": "uemail",
        }
         ```
      * b to f:
         ```JSON
         {
            "ifSuccess": "true / false",
            "err": "undefined / err message"
         }
         ```
   * refuse
      * f to b:
         ```JSON
         {
          "atoken": "atoken string",
          "uemail": "uemail",
        }
         ```
      * b to f:
         ```JSON
         {
            "ifSuccess": "true / false",
            "err": "undefined / err message"
         }
         ```

10. 系统日志
   * pull
      * f to b:
         ```JSON
         {
            "atoken": "atoken string"
         }
         ```
      * b to f:
         ```JSON
         {
            "syslog": [ {  "timestamp": "time stamp",
                           "role": "user / admin",
                           "who": "uemail / account",
                           "operation": ""},
                        {}, ... {} ],
            "counter": n
         }
         ```

---
## 关键技术及排坑记录

1. JWT(Token)  
  
    三部分:  
      * Header(头部) - 描述 JWT 的元数据  
      * Payload(负载) - 存放实际需要传递的数据  
      * Signature(签名) - 对前两部分的签名, 防止数据篡  
  
    签名:  
    ```javascript
    HMACSHA256( base64UrlEncode(header) + "." + base64UrlEncode(payload), secret)
    ```
  
    > [JWT_廖雪峰](https://www.ruanyifeng.com/blog/2018/07/json_web_token-tutorial.html)

2. Vue-Router
   
   > 用 Vue.js + Vue Router 创建单页应用  
   > 将组件 (components) 映射到路由 (routes)，然后告诉 Vue Router 在哪里渲染它们  

   * 导航解析流程: 
      1. 导航被触发
      2. 在失活的组件里调用 beforeRouteLeave 守卫。
      3. 调用全局的 beforeEach 守卫。
      4. 在重用的组件里调用 beforeRouteUpdate 守卫 (2.2+)。
      5. 在路由配置里调用 beforeEnter。
      6. 解析异步路由组件。
      7. 在被激活的组件里调用 beforeRouteEnter。
      8. 调用全局的 beforeResolve 守卫 (2.5+)。
      9. 导航被确认。
      10. 调用全局的 afterEach 钩子。
      11. 触发 DOM 更新。
      12. 调用 beforeRouteEnter 守卫中传给 next 的回调函数，创建好的组件实例会作为回调函数的参数传入。
   
   * 排坑:
     1. $router & $route
        * $router : 是路由操作对象，只写对象  
        * $route : 路由信息对象，只读对象  

   > [routerhistory模式的服务的配置](https://router.vuejs.org/zh/guide/essentials/history-mode.html#%E5%90%8E%E7%AB%AF%E9%85%8D%E7%BD%AE%E4%BE%8B%E5%AD%90)
   
   > [router 404配置](https://next.router.vuejs.org/guide/migration/index.html#moved-the-base-option)

3. Element-Plus
   
   > vue-cli4 暂时无法使用element-ui, 可以使用支持vue3.x的element-plus
   > 借助 babel-plugin-import, 可只引入需要的组件, 以达到减小项目体积的目的

   * 排坑:
     1. vue组件中若使用`<style scoped>`则vue在编译时会给每个组件加入`data-v-xxxxx`属性, 防止css污染, 遇到难以修改的组件样式, 尝试浏览器F12检查元素, 找到对应`class`, 在对应vue组件中`style`中, 使用`:deep()`深度选择器修饰该类名, 可实现修改
     2. el-table `:data` 绑定的只能是`array`, 如果使用其他会报错:**`TypeError: l.indexOf is not a function`**
     3. el-autocomplete 使用`:fetch-suggestions`时, 需要数组类型, 且只能识别`value`字段, 数据需要处理为`[ 'value': ...]`

4. iconfont - 阿里巴巴矢量图标库
   > 配合`element-plus`使用很方便, 极大地拓展了其自带的icon库
   
   * 使用: 
     1. 将所有`iconfong.xx`文件放入vue->src->assets->自建文件夹中, 然后在`main.js`中`import ./assets/icons/iconfont.css`即可
     2. 在element的标签中可以使用`icon`attribute的地方, 直接`<... icon="iconfont iconName>`, 接近element原生icon使用方法

   * 排坑:x

   > [官网传送门](https://www.iconfont.cn/)

5. mongodb - MongoDB官方Node.JS库
   
   > 安装 `npm install mongodb -S`

6. axios
   * 排坑: 
      1. 处理时 `let data = JSON.stringify(req.body);` 可简单转为string
         > 此时数据格式如下: `{"name":"David","age":"21"}`
         > 不可直接用 `data.name` 之类的操作
         > 但符合mongodb数据要求
     1. 再使用 `data = JSON.parse(data)` 可转化为JSON
         > 此时数据格式如下: `{ name: 'David', age: '21' }`
         > 能进行 `data.name` 之类的操作
         > 符合Vue的数据格式, 不过返回前端后还是会变成上面那样
